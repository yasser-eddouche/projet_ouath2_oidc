name: DevSecOps Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 2 * * 1" # Weekly scan on Monday at 2 AM

env:
  JAVA_VERSION: "21"
  NODE_VERSION: "20"

jobs:
  # Job 1: Build and Test
  build:
    name: Build & Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Shallow clones should be disabled for better analysis

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Build Config Service
        working-directory: ./config-service
        run: mvn clean package -DskipTests

      - name: Build Discovery Service
        working-directory: ./discovery-service
        run: mvn clean package -DskipTests

      - name: Build Gateway Service
        working-directory: ./gateway-service
        run: mvn clean package -DskipTests

      - name: Build Product Service
        working-directory: ./product-service
        run: mvn clean package -DskipTests

      - name: Build Order Service
        working-directory: ./order-service
        run: mvn clean package -DskipTests

      - name: Run Unit Tests
        run: |
          cd config-service && mvn test || true
          cd ../discovery-service && mvn test || true
          cd ../gateway-service && mvn test || true
          cd ../product-service && mvn test || true
          cd ../order-service && mvn test || true

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            **/target/*.jar
          retention-days: 7

  # Job 2: SAST - Static Application Security Testing with CodeQL
  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    needs: build
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["java-kotlin", "javascript-typescript"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        if: matrix.language == 'java-kotlin'
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Set up Node.js
        if: matrix.language == 'javascript-typescript'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: +security-extended,security-and-quality

      - name: Build Java Services
        if: matrix.language == 'java-kotlin'
        run: |
          mvn clean package -DskipTests -f config-service/pom.xml
          mvn clean package -DskipTests -f discovery-service/pom.xml
          mvn clean package -DskipTests -f gateway-service/pom.xml
          mvn clean package -DskipTests -f product-service/pom.xml
          mvn clean package -DskipTests -f order-service/pom.xml

      - name: Build Frontend
        if: matrix.language == 'javascript-typescript'
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # Job 3: SAST - ESLint for Frontend
  eslint-analysis:
    name: ESLint Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint || true

      - name: Upload ESLint Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: eslint-results
          path: frontend/eslint-report.json
          retention-days: 7

  # Job 4: Dependency Check - OWASP Dependency Analysis
  dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Run OWASP Dependency Check - All Services
        run: |
          for service in config-service discovery-service gateway-service product-service order-service; do
            echo "Running Dependency Check for $service..."
            cd $service
            mvn org.owasp:dependency-check-maven:check \
              -DfailBuildOnCVSS=7 \
              -DsuppressionFile=../dependency-check-suppressions.xml || true
            cd ..
          done

      - name: Upload Dependency Check Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-reports
          path: |
            **/target/dependency-check-report.html
            **/target/dependency-check-report.json
          retention-days: 30

      - name: Publish Dependency Check Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-results
          path: "**/target/dependency-check-report.*"

  # Job 5: Container Security - Trivy Scan
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker Images
        run: |
          docker build -t config-service:latest ./config-service
          docker build -t discovery-service:latest ./discovery-service
          docker build -t gateway-service:latest ./gateway-service
          docker build -t product-service:latest ./product-service
          docker build -t order-service:latest ./order-service
          docker build -t frontend:latest ./frontend

      - name: Run Trivy vulnerability scanner - Config Service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "config-service:latest"
          format: "sarif"
          output: "trivy-config-service.sarif"
          severity: "CRITICAL,HIGH"

      - name: Run Trivy vulnerability scanner - Discovery Service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "discovery-service:latest"
          format: "sarif"
          output: "trivy-discovery-service.sarif"
          severity: "CRITICAL,HIGH"

      - name: Run Trivy vulnerability scanner - Gateway Service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "gateway-service:latest"
          format: "sarif"
          output: "trivy-gateway-service.sarif"
          severity: "CRITICAL,HIGH"

      - name: Run Trivy vulnerability scanner - Product Service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "product-service:latest"
          format: "sarif"
          output: "trivy-product-service.sarif"
          severity: "CRITICAL,HIGH"

      - name: Run Trivy vulnerability scanner - Order Service
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "order-service:latest"
          format: "sarif"
          output: "trivy-order-service.sarif"
          severity: "CRITICAL,HIGH"

      - name: Run Trivy vulnerability scanner - Frontend
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "frontend:latest"
          format: "sarif"
          output: "trivy-frontend.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "."

      - name: Generate Trivy HTML Reports
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --format template --template "@contrib/html.tpl" \
            -o trivy-report-config.html config-service:latest || true
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --format template --template "@contrib/html.tpl" \
            -o trivy-report-product.html product-service:latest || true
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image --format template --template "@contrib/html.tpl" \
            -o trivy-report-order.html order-service:latest || true

      - name: Upload Trivy Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-reports
          path: |
            trivy-*.html
            trivy-*.sarif
          retention-days: 30

  # Job 6: Security Report Summary
  security-summary:
    name: Security Summary Report
    runs-on: ubuntu-latest
    needs: [codeql-analysis, eslint-analysis, dependency-check, trivy-scan]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all reports
        uses: actions/download-artifact@v4

      - name: Generate Security Summary
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "## Scan Date: $(date)" >> security-summary.md
          echo "" >> security-summary.md
          echo "### CodeQL Analysis" >> security-summary.md
          echo "✅ Static code analysis completed" >> security-summary.md
          echo "" >> security-summary.md
          echo "### ESLint Analysis" >> security-summary.md
          echo "✅ Frontend code quality scan completed" >> security-summary.md
          echo "" >> security-summary.md
          echo "### OWASP Dependency Check" >> security-summary.md
          echo "✅ Dependency vulnerability scan completed" >> security-summary.md
          echo "" >> security-summary.md
          echo "### Trivy Container Scan" >> security-summary.md
          echo "✅ Container image security scan completed" >> security-summary.md
          echo "" >> security-summary.md
          echo "Please review the detailed reports in the artifacts." >> security-summary.md

      - name: Upload Security Summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

      - name: Comment PR with Security Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # Job 7: Auto-fix vulnerabilities (optional)
  auto-fix:
    name: Auto-fix Vulnerabilities
    runs-on: ubuntu-latest
    needs: [dependency-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: maven

      - name: Update Dependencies
        run: |
          for service in config-service discovery-service gateway-service product-service order-service; do
            echo "Updating dependencies for $service..."
            cd $service
            mvn versions:use-latest-releases -DallowMajorUpdates=false || true
            cd ..
          done

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update dependencies to fix vulnerabilities"
          title: "[Security] Auto-fix dependency vulnerabilities"
          body: |
            ## Automated Security Fix

            This PR was automatically created by the DevSecOps pipeline.

            ### Changes:
            - Updated dependencies to latest secure versions
            - Fixed vulnerabilities detected by OWASP Dependency Check

            Please review the changes before merging.
          branch: security/auto-fix-dependencies
          delete-branch: true
